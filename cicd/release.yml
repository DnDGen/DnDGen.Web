trigger: none
pr: none

resources:
  pipelines:
  - pipeline: DnDGen.Web
    source: 'DnDGen.Web - Build'
    trigger: 
      branches:
      - main

jobs:

# The RollGen API
- deployment: RollGen_Api
  displayName: Deploy RollGen API
  pool:
    vmImage: 'windows-latest'
  environment: Prod
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureFunctionApp@2
          displayName: 'Deploy Azure Function App'
          inputs:
            connectedServiceNameARM: 'Azure - DnDGen'
            appType: 'functionApp'
            appName: 'rollgen-api'
            package: '$(Pipeline.Workspace)/**/rollgen-api/*.zip'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-api-tests\RollGen-API.postman_collection.json --reporters cli,junit --reporter-junit-export Results\rollgen.junitReport.xml'
          displayName: 'Run RollGen API Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: UseNode@1
          displayName: 'Install node.js'
          inputs:
            version: '20.x'
        - task: Npm@1  
          displayName: 'Install Angular CLI'  
          inputs:  
            command: custom  
            verbose: true  
            customCommand: 'install -g @angular/cli'
        - task: Npm@1  
          displayName: 'npm install'  
          inputs:
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            command: install
        - task: Npm@1  
          displayName: Run Website Tests
          retryCountOnTaskFailure: 1
          inputs: 
            command: custom
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            customCommand: 'run test:ci'
        - task: PublishTestResults@2
          displayName: 'Publish Website Test Results'
          condition: always()
          inputs:
            testResultsFiles: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests\**\TESTS-*.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)\rollback'
              itemPattern: DnDGen.Api.RollGen.zip
          - task: AzureFunctionApp@2
            displayName: 'Rollback Azure Function App'
            inputs:
              connectedServiceNameARM: 'Azure - DnDGen'
              appType: 'functionApp'
              appName: 'rollgen-api'
              package: '$(Pipeline.Workspace)/rollback/DnDGen.Api.RollGen.zip'
     
# The TreasureGen API       
- deployment: TreasureGen_Api
  displayName: Deploy TreasureGen API
  pool:
    vmImage: 'windows-latest'
  environment: Prod
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureFunctionApp@2
          displayName: 'Deploy Azure Function App'
          inputs:
            connectedServiceNameARM: 'Azure - DnDGen'
            appType: 'functionApp'
            appName: 'treasuregen-api'
            package: '$(Pipeline.Workspace)/**/treasuregen-api/*.zip'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-api-tests\TreasureGen-API.postman_collection.json --reporters cli,junit --reporter-junit-export Results\treasuregen.junitReport.xml'
          displayName: 'Run TreasureGen API Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: UseNode@1
          displayName: 'Install node.js'
          inputs:
            version: '20.x'
        - task: Npm@1  
          displayName: 'Install Angular CLI'  
          inputs:  
            command: custom  
            verbose: true  
            customCommand: 'install -g @angular/cli'
        - task: Npm@1  
          displayName: 'npm install'  
          inputs:
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            command: install
        - task: Npm@1  
          displayName: Run Website Tests
          retryCountOnTaskFailure: 1
          inputs: 
            command: custom
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            customCommand: 'run test:ci'
        - task: PublishTestResults@2
          displayName: 'Publish Website Test Results'
          condition: always()
          inputs:
            testResultsFiles: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests\**\TESTS-*.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)\rollback'
              itemPattern: DnDGen.Api.TreasureGen.zip
          - task: AzureFunctionApp@2
            displayName: 'Rollback Azure Function App'
            inputs:
              connectedServiceNameARM: 'Azure - DnDGen'
              appType: 'functionApp'
              appName: 'treasuregen-api'
              package: '$(Pipeline.Workspace)/rollback/DnDGen.Api.TreasureGen.zip'

# The CharacterGen API       
- deployment: CharacterGen_Api
  displayName: Deploy CharacterGen API
  pool:
    vmImage: 'windows-latest'
  environment: Prod
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureFunctionApp@2
          displayName: 'Deploy Azure Function App'
          inputs:
            connectedServiceNameARM: 'Azure - DnDGen'
            appType: 'functionApp'
            appName: 'charactergen-api'
            package: '$(Pipeline.Workspace)/**/charactergen-api/*.zip'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-api-tests\CharacterGen-API.postman_collection.json --reporters cli,junit --reporter-junit-export Results\charactergen.junitReport.xml'
          displayName: 'Run CharacterGen API Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: UseNode@1
          displayName: 'Install node.js'
          inputs:
            version: '20.x'
        - task: Npm@1  
          displayName: 'Install Angular CLI'  
          inputs:  
            command: custom  
            verbose: true  
            customCommand: 'install -g @angular/cli'
        - task: Npm@1  
          displayName: 'npm install'  
          inputs:
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            command: install
        - task: Npm@1  
          displayName: Run Website Tests
          retryCountOnTaskFailure: 1
          inputs: 
            command: custom
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            customCommand: 'run test:ci'
        - task: PublishTestResults@2
          displayName: 'Publish Website Test Results'
          condition: always()
          inputs:
            testResultsFiles: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests\**\TESTS-*.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)\rollback'
              itemPattern: DnDGen.Api.CharacterGen.zip
          - task: AzureFunctionApp@2
            displayName: 'Rollback Azure Function App'
            inputs:
              connectedServiceNameARM: 'Azure - DnDGen'
              appType: 'functionApp'
              appName: 'charactergen-api'
              package: '$(Pipeline.Workspace)/rollback/DnDGen.Api.CharacterGen.zip'

# The EncounterGen API       
- deployment: EncounterGen_Api
  displayName: Deploy EncounterGen API
  pool:
    vmImage: 'windows-latest'
  environment: Prod
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureFunctionApp@2
          displayName: 'Deploy Azure Function App'
          inputs:
            connectedServiceNameARM: 'Azure - DnDGen'
            appType: 'functionApp'
            appName: 'encountergen-api'
            package: '$(Pipeline.Workspace)/**/encountergen-api/*.zip'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-api-tests\EncounterGen-API.postman_collection.json --reporters cli,junit --reporter-junit-export Results\encountergen.junitReport.xml'
          displayName: 'Run EncounterGen API Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: UseNode@1
          displayName: 'Install node.js'
          inputs:
            version: '20.x'
        - task: Npm@1  
          displayName: 'Install Angular CLI'  
          inputs:  
            command: custom  
            verbose: true  
            customCommand: 'install -g @angular/cli'
        - task: Npm@1  
          displayName: 'npm install'  
          inputs:
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            command: install
        - task: Npm@1  
          displayName: Run Website Tests
          retryCountOnTaskFailure: 1
          inputs: 
            command: custom
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            customCommand: 'run test:ci'
        - task: PublishTestResults@2
          displayName: 'Publish Website Test Results'
          condition: always()
          inputs:
            testResultsFiles: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests\**\TESTS-*.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)\rollback'
              itemPattern: DnDGen.Api.EncounterGen.zip
          - task: AzureFunctionApp@2
            displayName: 'Rollback Azure Function App'
            inputs:
              connectedServiceNameARM: 'Azure - DnDGen'
              appType: 'functionApp'
              appName: 'encountergen-api'
              package: '$(Pipeline.Workspace)/rollback/DnDGen.Api.EncounterGen.zip'

# The DungeonGen API       
- deployment: DungeonGen_Api
  displayName: Deploy DungeonGen API
  pool:
    vmImage: 'windows-latest'
  environment: Prod
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureFunctionApp@2
          displayName: 'Deploy Azure Function App'
          inputs:
            connectedServiceNameARM: 'Azure - DnDGen'
            appType: 'functionApp'
            appName: 'dungeongen-api'
            package: '$(Pipeline.Workspace)/**/dungeongen-api/*.zip'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-api-tests\DungeonGen-API.postman_collection.json --reporters cli,junit --reporter-junit-export Results\dungeongen.junitReport.xml'
          displayName: 'Run DungeonGen API Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: UseNode@1
          displayName: 'Install node.js'
          inputs:
            version: '20.x'
        - task: Npm@1  
          displayName: 'Install Angular CLI'  
          inputs:  
            command: custom  
            verbose: true  
            customCommand: 'install -g @angular/cli'
        - task: Npm@1  
          displayName: 'npm install'  
          inputs:
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            command: install
        - task: Npm@1  
          displayName: Run Website Tests
          retryCountOnTaskFailure: 1
          inputs: 
            command: custom
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            customCommand: 'run test:ci'
        - task: PublishTestResults@2
          displayName: 'Publish Website Test Results'
          condition: always()
          inputs:
            testResultsFiles: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests\**\TESTS-*.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)\rollback'
              itemPattern: DnDGen.Api.DungeonGen.zip
          - task: AzureFunctionApp@2
            displayName: 'Rollback Azure Function App'
            inputs:
              connectedServiceNameARM: 'Azure - DnDGen'
              appType: 'functionApp'
              appName: 'dungeongen-api'
              package: '$(Pipeline.Workspace)/rollback/DnDGen.Api.DungeonGen.zip'

# The Web API
- deployment: Web_Api
  displayName: Deploy Web API
  pool:
    vmImage: 'windows-latest'
  environment: Prod
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureFunctionApp@2
          displayName: 'Deploy Azure Function App'
          inputs:
            connectedServiceNameARM: 'Azure - DnDGen'
            appType: 'functionApp'
            appName: 'dndgen-web-api'
            package: '$(Pipeline.Workspace)/**/dndgen-web-api/*.zip'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-api-tests\Web-API.postman_collection.json --reporters cli,junit --reporter-junit-export Results\web.junitReport.xml'
          displayName: 'Run Web API Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: UseNode@1
          displayName: 'Install node.js'
          inputs:
            version: '20.x'
        - task: Npm@1  
          displayName: 'Install Angular CLI'  
          inputs:  
            command: custom  
            verbose: true  
            customCommand: 'install -g @angular/cli'
        - task: Npm@1  
          displayName: 'npm install'  
          inputs:
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            command: install
        - task: Npm@1  
          displayName: Run Website Tests
          retryCountOnTaskFailure: 1
          inputs: 
            command: custom
            workingDir: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests'
            verbose: true  
            customCommand: 'run test:ci'
        - task: PublishTestResults@2
          displayName: 'Publish Website Test Results'
          condition: always()
          inputs:
            testResultsFiles: '$(Pipeline.Workspace)\DnDGen.Web\dndgen-deployment-website-tests\**\TESTS-*.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)\rollback'
              itemPattern: DnDGen.Api.Web.zip
          - task: AzureFunctionApp@2
            displayName: 'Rollback Azure Function App'
            inputs:
              connectedServiceNameARM: 'Azure - DnDGen'
              appType: 'functionApp'
              appName: 'dndgen-web-api'
              package: '$(Pipeline.Workspace)/rollback/DnDGen.Api.Web.zip'
     
# The DnDGen Website
- deployment: Website
  displayName: Deploy Website
  pool:
    vmImage: 'ubuntu-latest'
  environment: Prod
  dependsOn:
  - RollGen_Api
  - TreasureGen_Api
  - CharacterGen_Api
  - EncounterGen_Api
  - DungeonGen_Api
  - Web_Api
  strategy:
    runOnce:
      deploy:
        steps:
        - task: AzureStaticWebApp@0
          displayName: 'Azure Static Web App Deploy: dndgen-web'
          retryCountOnTaskFailure: 3
          inputs:
            cwd: '$(Pipeline.Workspace)/DnDGen.Web/dndgen-web'
            app_location: '/dndgen-web/browser'
            output_location: ''
            skip_app_build: true
            skip_api_build: true
            verbose: true
            azure_static_web_apps_api_token: '$(deployment_token)'
        - script: 'npm install -g newman'
          workingDirectory: '$(Pipeline.Workspace)'
          displayName: 'Install Newman'
        - script: 'newman run $(Pipeline.Workspace)/DnDGen.Web/dndgen-deployment-api-tests/DnDGen-Website.postman_collection.json --reporters cli,junit --reporter-junit-export Results/website.junitReport.xml'
          displayName: 'Run DnDGen Website Tests'
          retryCountOnTaskFailure: 1
        - task: PublishTestResults@2
          displayName: 'Publish Postman Test Results'
          condition: always()
          inputs:
            testResultsFiles: '**/*.junitReport.xml'
            failTaskOnFailedTests: true
            failTaskOnMissingResultsFile: true
        - task: ArchiveFiles@2
          displayName: 'Zip Website Artifacts'
          inputs:
            rootFolderOrFile: '$(Pipeline.Workspace)/DnDGen.Web/dndgen-web'
            includeRootFolder: false
            archiveFile: '$(Pipeline.Workspace)/DnDGen.Web/dndgen-web.zip'
        - task: GitHubRelease@1
          displayName: 'GitHub release (create)'
          inputs:
            gitHubConnection: 'github.com_cidthecoatrack'
            assets: |
              $(Pipeline.Workspace)/**/rollgen-api/*.zip
              $(Pipeline.Workspace)/**/treasuregen-api/*.zip
              $(Pipeline.Workspace)/**/charactergen-api/*.zip
              $(Pipeline.Workspace)/**/encountergen-api/*.zip
              $(Pipeline.Workspace)/**/dungeongen-api/*.zip
              $(Pipeline.Workspace)/**/dndgen-web-api/*.zip
              $(Pipeline.Workspace)/DnDGen.Web/dndgen-web.zip
      on:
        failure:
          steps:
          - task: DownloadGitHubRelease@0
            displayName: 'Download Rollback Release'
            inputs:
              connection: 'github.com_cidthecoatrack'
              userRepository: 'DnDGen/DnDGen.Web'
              downloadPath: '$(Pipeline.Workspace)/rollback'
              itemPattern: dndgen-web.zip
          - task: ExtractFiles@1
            displayName: 'Extract Website Rollback Artifacts'
            inputs:
              archiveFilePatterns: '$(Pipeline.Workspace)/rollback/dndgen-web.zip'
              destinationFolder: '$(Pipeline.Workspace)/rollback'
          - task: AzureStaticWebApp@0
            displayName: 'Rollback dndgen-web'
            retryCountOnTaskFailure: 3
            inputs:
              cwd: '$(Pipeline.Workspace)/rollback/dndgen-web'
              app_location: '/dndgen-web/browser'
              output_location: ''
              skip_app_build: true
              skip_api_build: true
              verbose: true
              azure_static_web_apps_api_token: '$(deployment_token)'
